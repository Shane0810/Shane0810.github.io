{"title":"Redis学习系列（四）主从复制","slug":"Redis学习系列（四）主从复制","date":"2020-06-20T14:55:56.000Z","updated":"2020-06-20T15:03:15.652Z","comments":true,"path":"api/articles/Redis学习系列（四）主从复制.json","excerpt":null,"covers":["image-20200620224443469.png","image-20200620225048149.png","image-20200620220120366.png","image-20200620220639671.png","image-20200620220651142.png","image-20200620220740201.png","image-20200620220854684.png"],"content":"<h1 id=\"Redis（四）主从复制\"><a href=\"#Redis（四）主从复制\" class=\"headerlink\" title=\"Redis（四）主从复制\"></a>Redis（四）主从复制</h1><h2 id=\"概念\"><a href=\"#概念\" class=\"headerlink\" title=\"概念\"></a>概念</h2><p>主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器，前者成为主节点（master）后者成为从节点（slave）；数据的复制是单向的，只能由主节点到从节点，Master以写为主，Slave只能读。</p>\n<p>默认情况下，每台Redis服务器都是主节点，且一个主节点可以由多个从节点或者没有从节点。但是一个从节点只有一个主节点。</p>\n<p><strong>主从复制的作用主要包括</strong></p>\n<ul>\n<li>数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式</li>\n<li>故障恢复：当主节点出现问题，可以由从节点提供服务，实现快速的故障恢复，实际上是一种服务的冗余</li>\n<li>负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时连接主节点，读redis时应用从节点），分担服务器 负载，尤其在读多写少的情况之下。通过多个从节点分担读负载，可以大大提高redis的并发量</li>\n<li>高可用（集群）的基石：除了上述作用之外，主从复制还是哨兵和集群能够实现的基础，因此说是Redis高可用的基石。</li>\n</ul>\n<p>一般来说，要将Redis运用在实际的项目中，只使用一台Redis服务器是不可能的，原因：</p>\n<ul>\n<li>从结构上，单个Redis服务器会发生单点故障，一台服务器需要处理所有的负载，压力较大</li>\n<li>从容量上，单个Redis服务器内存容量限制，一般来说，单台Redis最大使用内存不应该超过20G</li>\n</ul>\n<h2 id=\"环境配置\"><a href=\"#环境配置\" class=\"headerlink\" title=\"环境配置\"></a>环境配置</h2><p>只需要配置从库，不需要配置主库，默认都是主库</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; info replication<span class=\"comment\"># 查看当前库的信息</span></span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\">role:master<span class=\"comment\">#表示主库</span></span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\">master_replid:b242cbcae6532b3a74762010786610af9cdefecc</span><br><span class=\"line\">master_replid2:0000000000000000000000000000000000000000</span><br><span class=\"line\">master_repl_offset:0</span><br><span class=\"line\">master_repl_meaningful_offset:0</span><br><span class=\"line\">second_repl_offset:-1</span><br><span class=\"line\">repl_backlog_active:0</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:0</span><br><span class=\"line\">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>\n\n<p>复制三个配置文件，修改配置</p>\n<p>1、端口号</p>\n<p>2、pid名字</p>\n<p>3、log文件名字</p>\n<p>4、dump.rdb名字</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># redis-server myconfig/redis-79.conf </span></span><br><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># ll</span></span><br><span class=\"line\">total 45932</span><br><span class=\"line\">-rw-r--r-- 1 root root     2380 Jun 20 21:31 6379.log</span><br><span class=\"line\">-rw-r--r-- 1 root root      114 Jun 20 21:20 dump.rdb</span><br><span class=\"line\">drwxr-xr-x 2 root root     4096 Jun 20 21:30 myconfig</span><br><span class=\"line\">-rwxr-xr-x 1 root root  6397464 Jun 18 12:18 redis-benchmark</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-check-aof</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-check-rdb</span><br><span class=\"line\">-rwxr-xr-x 1 root root  6719864 Jun 18 12:18 redis-cli</span><br><span class=\"line\">lrwxrwxrwx 1 root root       12 Jun 18 12:18 redis-sentinel -&gt; redis-server</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-server</span><br><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># redis-server myconfig/redis-80.conf </span></span><br><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># redis-server myconfig/redis-81.conf </span></span><br><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># ll</span></span><br><span class=\"line\">total 45940</span><br><span class=\"line\">-rw-r--r-- 1 root root     2380 Jun 20 21:31 6379.log</span><br><span class=\"line\">-rw-r--r-- 1 root root     2380 Jun 20 21:32 6380.log</span><br><span class=\"line\">-rw-r--r-- 1 root root     2380 Jun 20 21:32 6381.log</span><br><span class=\"line\">-rw-r--r-- 1 root root      114 Jun 20 21:20 dump.rdb</span><br><span class=\"line\">drwxr-xr-x 2 root root     4096 Jun 20 21:30 myconfig</span><br><span class=\"line\">-rwxr-xr-x 1 root root  6397464 Jun 18 12:18 redis-benchmark</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-check-aof</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-check-rdb</span><br><span class=\"line\">-rwxr-xr-x 1 root root  6719864 Jun 18 12:18 redis-cli</span><br><span class=\"line\">lrwxrwxrwx 1 root root       12 Jun 18 12:18 redis-sentinel -&gt; redis-server</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-server</span><br><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># ps -ef|grep redis</span></span><br><span class=\"line\">root     11466     1  0 21:31 ?        00:00:00 redis-server 127.0.0.1:6379</span><br><span class=\"line\">root     11473     1  0 21:32 ?        00:00:00 redis-server 127.0.0.1:6380</span><br><span class=\"line\">root     11479     1  0 21:32 ?        00:00:00 redis-server 127.0.0.1:6381</span><br><span class=\"line\">root     11488 11125  0 21:32 pts/0    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"一主二从\"><a href=\"#一主二从\" class=\"headerlink\" title=\"一主二从\"></a>一主二从</h2><p>目前，所有的都是主节点。只需要配置从机</p>\n<p>从机配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6380&gt; slaveof 127.0.0.1 6379</span><br><span class=\"line\">OK</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#从机6380</span></span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1:6380&gt; info replication</span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\">role:slave</span><br><span class=\"line\">master_host:127.0.0.1</span><br><span class=\"line\">master_port:6379</span><br><span class=\"line\">master_link_status:up</span><br><span class=\"line\">master_last_io_seconds_ago:1</span><br><span class=\"line\">master_sync_in_progress:0</span><br><span class=\"line\">slave_repl_offset:0</span><br><span class=\"line\">slave_priority:100</span><br><span class=\"line\">slave_read_only:1</span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\">master_replid:bb15c7dc4a4e0290cc5c0cafef652d2a8f2f91dc</span><br><span class=\"line\">master_replid2:0000000000000000000000000000000000000000</span><br><span class=\"line\">master_repl_offset:0</span><br><span class=\"line\">master_repl_meaningful_offset:0</span><br><span class=\"line\">second_repl_offset:-1</span><br><span class=\"line\">repl_backlog_active:1</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:1</span><br><span class=\"line\">repl_backlog_histlen:0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#从机6281</span></span><br><span class=\"line\">127.0.0.1:6381&gt; slaveof 127.0.0.1 6379</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6381&gt; info replication</span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\">role:slave</span><br><span class=\"line\">master_host:127.0.0.1</span><br><span class=\"line\">master_port:6379</span><br><span class=\"line\">master_link_status:up</span><br><span class=\"line\">master_last_io_seconds_ago:1</span><br><span class=\"line\">master_sync_in_progress:0</span><br><span class=\"line\">slave_repl_offset:168</span><br><span class=\"line\">slave_priority:100</span><br><span class=\"line\">slave_read_only:1</span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\">master_replid:bb15c7dc4a4e0290cc5c0cafef652d2a8f2f91dc</span><br><span class=\"line\">master_replid2:0000000000000000000000000000000000000000</span><br><span class=\"line\">master_repl_offset:168</span><br><span class=\"line\">master_repl_meaningful_offset:154</span><br><span class=\"line\">second_repl_offset:-1</span><br><span class=\"line\">repl_backlog_active:1</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:155</span><br><span class=\"line\">repl_backlog_histlen:14</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#主机中查看信息。</span></span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1:6379&gt; info replication</span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\">role:master</span><br><span class=\"line\">connected_slaves:2</span><br><span class=\"line\">slave0:ip=127.0.0.1,port=6380,state=online,offset=182,lag=1</span><br><span class=\"line\">slave1:ip=127.0.0.1,port=6381,state=online,offset=182,lag=1</span><br><span class=\"line\">master_replid:bb15c7dc4a4e0290cc5c0cafef652d2a8f2f91dc</span><br><span class=\"line\">master_replid2:0000000000000000000000000000000000000000</span><br><span class=\"line\">master_repl_offset:182</span><br><span class=\"line\">master_repl_meaningful_offset:0</span><br><span class=\"line\">second_repl_offset:-1</span><br><span class=\"line\">repl_backlog_active:1</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:1</span><br><span class=\"line\">repl_backlog_histlen:182</span><br><span class=\"line\">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"永久配置主从\"><a href=\"#永久配置主从\" class=\"headerlink\" title=\"永久配置主从\"></a>永久配置主从</h3><blockquote>\n<p>REPLICATION</p>\n</blockquote>\n<p>直接在配置文件中修改该字段。</p>\n<h2 id=\"主从复制的细节\"><a href=\"#主从复制的细节\" class=\"headerlink\" title=\"主从复制的细节\"></a>主从复制的细节</h2><ul>\n<li>主机可以写，从机不能，只能读</li>\n<li>主机中的所有数据和信息，都自动被从机保存。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6380&gt; keys *</span><br><span class=\"line\">1) <span class=\"string\">\"k1\"</span></span><br><span class=\"line\">127.0.0.1:6380&gt; get k1</span><br><span class=\"line\"><span class=\"string\">\"v1\"</span></span><br><span class=\"line\">127.0.0.1:6380&gt; <span class=\"built_in\">set</span> k2 v2</span><br><span class=\"line\">(error) READONLY You can<span class=\"string\">'t write against a read only replica.</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>主机断开连接，从机依旧连接到主机，重新连接之后，正常工作。</li>\n</ul>\n<p><strong>复制原理</strong><br>Slave启动成功之后连接到master后会发送一个sync命令</p>\n<p>Master接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集的命令，在后台进程执行完毕之hi偶，master将传送整个数据文件到slave，并完成一次完全同步。</p>\n<p>全量复制：slave服务在接收到数据库文件数据后，将其存盘并加载到内存中</p>\n<p>增量复制：Master继续将新的所有收集到的修改命令依次传递个slave，完成同步</p>\n<p>但是要重新连接master，一次完全同步（全量复制）将被自动执行。</p>\n<h2 id=\"哨兵模式（重点）\"><a href=\"#哨兵模式（重点）\" class=\"headerlink\" title=\"哨兵模式（重点）\"></a>哨兵模式（重点）</h2><h3 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h3><p>主从切换技术的方法是：当主服务器宕机之后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费时费力，同时会造成一段时间内服务不可用。更多时候，需要考虑使用哨兵模式。</p>\n<p>哨兵模式是一种特殊的模式，首先Redis提供哨兵的命令，哨兵是一个独立的进程，作为进程，独立运行。原理是<strong>哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例</strong></p>\n<p>在这里，烧饼的两个作用</p>\n<ul>\n<li>通过发送命令，让Redis服务器返回监控器运行状态信息，包括主从服务器</li>\n<li>当哨兵监测到master宕机，会自动将slave切换成master，然后通过发部订阅模式通知其他的从服务器，修改配置文件，切换主机。</li>\n</ul>\n<p><img src=\"image-20200620224443469.png\" alt=\"alt\"></p>\n<p>然而一个哨兵进程对Redis服务器进行监控，可能会 出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控</p>\n<p><img src=\"image-20200620225048149.png\" alt=\"alt\"></p>\n<p>假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover过程，仅仅是哨兵1主观的认为主服务器不可用，这个想象称为<strong>主观下线</strong>。当后面的哨兵也检测到主服务器不可用，并且数量达到一定的值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行failover（故障转移）操作。切换成功周，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为<strong>客观下线</strong>。</p>\n<h3 id=\"配置哨兵配置文件sentinel-conf\"><a href=\"#配置哨兵配置文件sentinel-conf\" class=\"headerlink\" title=\"配置哨兵配置文件sentinel.conf\"></a>配置哨兵配置文件sentinel.conf</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#sentinel monitor 被监控的名称 host port 1</span></span><br><span class=\"line\">sentinel monitor myredis 127.0.0.1 6379 1</span><br></pre></td></tr></table></figure>\n\n<p>后面的数字1，代表主机挂了，slave投票看让谁替换成为主机，票数最多的，成为主机</p>\n<h3 id=\"启动哨兵\"><a href=\"#启动哨兵\" class=\"headerlink\" title=\"启动哨兵\"></a>启动哨兵</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis-sentinel myconfig/setinel.conf</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"image-20200620220120366.png\" alt=\"alt\"></p>\n<h3 id=\"主机宕机\"><a href=\"#主机宕机\" class=\"headerlink\" title=\"主机宕机\"></a>主机宕机</h3><p><img src=\"image-20200620220639671.png\" alt=\"alt\"></p>\n<p><img src=\"image-20200620220651142.png\" alt=\"alt\"></p>\n<p>发现主机已经变为6380</p>\n<p><img src=\"image-20200620220740201.png\" alt=\"alt\"></p>\n<p>如果主机回来了，只能成为slave</p>\n<p><img src=\"image-20200620220854684.png\" alt=\"alt\"></p>\n","more":"<h1 id=\"Redis（四）主从复制\"><a href=\"#Redis（四）主从复制\" class=\"headerlink\" title=\"Redis（四）主从复制\"></a>Redis（四）主从复制</h1><h2 id=\"概念\"><a href=\"#概念\" class=\"headerlink\" title=\"概念\"></a>概念</h2><p>主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器，前者成为主节点（master）后者成为从节点（slave）；数据的复制是单向的，只能由主节点到从节点，Master以写为主，Slave只能读。</p>\n<p>默认情况下，每台Redis服务器都是主节点，且一个主节点可以由多个从节点或者没有从节点。但是一个从节点只有一个主节点。</p>\n<p><strong>主从复制的作用主要包括</strong></p>\n<ul>\n<li>数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式</li>\n<li>故障恢复：当主节点出现问题，可以由从节点提供服务，实现快速的故障恢复，实际上是一种服务的冗余</li>\n<li>负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时连接主节点，读redis时应用从节点），分担服务器 负载，尤其在读多写少的情况之下。通过多个从节点分担读负载，可以大大提高redis的并发量</li>\n<li>高可用（集群）的基石：除了上述作用之外，主从复制还是哨兵和集群能够实现的基础，因此说是Redis高可用的基石。</li>\n</ul>\n<p>一般来说，要将Redis运用在实际的项目中，只使用一台Redis服务器是不可能的，原因：</p>\n<ul>\n<li>从结构上，单个Redis服务器会发生单点故障，一台服务器需要处理所有的负载，压力较大</li>\n<li>从容量上，单个Redis服务器内存容量限制，一般来说，单台Redis最大使用内存不应该超过20G</li>\n</ul>\n<h2 id=\"环境配置\"><a href=\"#环境配置\" class=\"headerlink\" title=\"环境配置\"></a>环境配置</h2><p>只需要配置从库，不需要配置主库，默认都是主库</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; info replication<span class=\"comment\"># 查看当前库的信息</span></span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\">role:master<span class=\"comment\">#表示主库</span></span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\">master_replid:b242cbcae6532b3a74762010786610af9cdefecc</span><br><span class=\"line\">master_replid2:0000000000000000000000000000000000000000</span><br><span class=\"line\">master_repl_offset:0</span><br><span class=\"line\">master_repl_meaningful_offset:0</span><br><span class=\"line\">second_repl_offset:-1</span><br><span class=\"line\">repl_backlog_active:0</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:0</span><br><span class=\"line\">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>\n\n<p>复制三个配置文件，修改配置</p>\n<p>1、端口号</p>\n<p>2、pid名字</p>\n<p>3、log文件名字</p>\n<p>4、dump.rdb名字</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># redis-server myconfig/redis-79.conf </span></span><br><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># ll</span></span><br><span class=\"line\">total 45932</span><br><span class=\"line\">-rw-r--r-- 1 root root     2380 Jun 20 21:31 6379.log</span><br><span class=\"line\">-rw-r--r-- 1 root root      114 Jun 20 21:20 dump.rdb</span><br><span class=\"line\">drwxr-xr-x 2 root root     4096 Jun 20 21:30 myconfig</span><br><span class=\"line\">-rwxr-xr-x 1 root root  6397464 Jun 18 12:18 redis-benchmark</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-check-aof</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-check-rdb</span><br><span class=\"line\">-rwxr-xr-x 1 root root  6719864 Jun 18 12:18 redis-cli</span><br><span class=\"line\">lrwxrwxrwx 1 root root       12 Jun 18 12:18 redis-sentinel -&gt; redis-server</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-server</span><br><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># redis-server myconfig/redis-80.conf </span></span><br><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># redis-server myconfig/redis-81.conf </span></span><br><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># ll</span></span><br><span class=\"line\">total 45940</span><br><span class=\"line\">-rw-r--r-- 1 root root     2380 Jun 20 21:31 6379.log</span><br><span class=\"line\">-rw-r--r-- 1 root root     2380 Jun 20 21:32 6380.log</span><br><span class=\"line\">-rw-r--r-- 1 root root     2380 Jun 20 21:32 6381.log</span><br><span class=\"line\">-rw-r--r-- 1 root root      114 Jun 20 21:20 dump.rdb</span><br><span class=\"line\">drwxr-xr-x 2 root root     4096 Jun 20 21:30 myconfig</span><br><span class=\"line\">-rwxr-xr-x 1 root root  6397464 Jun 18 12:18 redis-benchmark</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-check-aof</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-check-rdb</span><br><span class=\"line\">-rwxr-xr-x 1 root root  6719864 Jun 18 12:18 redis-cli</span><br><span class=\"line\">lrwxrwxrwx 1 root root       12 Jun 18 12:18 redis-sentinel -&gt; redis-server</span><br><span class=\"line\">-rwxr-xr-x 1 root root 11300096 Jun 18 12:18 redis-server</span><br><span class=\"line\">[root@izbp10mqmhqvedm1cjhdulz bin]<span class=\"comment\"># ps -ef|grep redis</span></span><br><span class=\"line\">root     11466     1  0 21:31 ?        00:00:00 redis-server 127.0.0.1:6379</span><br><span class=\"line\">root     11473     1  0 21:32 ?        00:00:00 redis-server 127.0.0.1:6380</span><br><span class=\"line\">root     11479     1  0 21:32 ?        00:00:00 redis-server 127.0.0.1:6381</span><br><span class=\"line\">root     11488 11125  0 21:32 pts/0    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"一主二从\"><a href=\"#一主二从\" class=\"headerlink\" title=\"一主二从\"></a>一主二从</h2><p>目前，所有的都是主节点。只需要配置从机</p>\n<p>从机配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6380&gt; slaveof 127.0.0.1 6379</span><br><span class=\"line\">OK</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#从机6380</span></span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1:6380&gt; info replication</span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\">role:slave</span><br><span class=\"line\">master_host:127.0.0.1</span><br><span class=\"line\">master_port:6379</span><br><span class=\"line\">master_link_status:up</span><br><span class=\"line\">master_last_io_seconds_ago:1</span><br><span class=\"line\">master_sync_in_progress:0</span><br><span class=\"line\">slave_repl_offset:0</span><br><span class=\"line\">slave_priority:100</span><br><span class=\"line\">slave_read_only:1</span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\">master_replid:bb15c7dc4a4e0290cc5c0cafef652d2a8f2f91dc</span><br><span class=\"line\">master_replid2:0000000000000000000000000000000000000000</span><br><span class=\"line\">master_repl_offset:0</span><br><span class=\"line\">master_repl_meaningful_offset:0</span><br><span class=\"line\">second_repl_offset:-1</span><br><span class=\"line\">repl_backlog_active:1</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:1</span><br><span class=\"line\">repl_backlog_histlen:0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#从机6281</span></span><br><span class=\"line\">127.0.0.1:6381&gt; slaveof 127.0.0.1 6379</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6381&gt; info replication</span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\">role:slave</span><br><span class=\"line\">master_host:127.0.0.1</span><br><span class=\"line\">master_port:6379</span><br><span class=\"line\">master_link_status:up</span><br><span class=\"line\">master_last_io_seconds_ago:1</span><br><span class=\"line\">master_sync_in_progress:0</span><br><span class=\"line\">slave_repl_offset:168</span><br><span class=\"line\">slave_priority:100</span><br><span class=\"line\">slave_read_only:1</span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\">master_replid:bb15c7dc4a4e0290cc5c0cafef652d2a8f2f91dc</span><br><span class=\"line\">master_replid2:0000000000000000000000000000000000000000</span><br><span class=\"line\">master_repl_offset:168</span><br><span class=\"line\">master_repl_meaningful_offset:154</span><br><span class=\"line\">second_repl_offset:-1</span><br><span class=\"line\">repl_backlog_active:1</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:155</span><br><span class=\"line\">repl_backlog_histlen:14</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#主机中查看信息。</span></span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1:6379&gt; info replication</span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\">role:master</span><br><span class=\"line\">connected_slaves:2</span><br><span class=\"line\">slave0:ip=127.0.0.1,port=6380,state=online,offset=182,lag=1</span><br><span class=\"line\">slave1:ip=127.0.0.1,port=6381,state=online,offset=182,lag=1</span><br><span class=\"line\">master_replid:bb15c7dc4a4e0290cc5c0cafef652d2a8f2f91dc</span><br><span class=\"line\">master_replid2:0000000000000000000000000000000000000000</span><br><span class=\"line\">master_repl_offset:182</span><br><span class=\"line\">master_repl_meaningful_offset:0</span><br><span class=\"line\">second_repl_offset:-1</span><br><span class=\"line\">repl_backlog_active:1</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:1</span><br><span class=\"line\">repl_backlog_histlen:182</span><br><span class=\"line\">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"永久配置主从\"><a href=\"#永久配置主从\" class=\"headerlink\" title=\"永久配置主从\"></a>永久配置主从</h3><blockquote>\n<p>REPLICATION</p>\n</blockquote>\n<p>直接在配置文件中修改该字段。</p>\n<h2 id=\"主从复制的细节\"><a href=\"#主从复制的细节\" class=\"headerlink\" title=\"主从复制的细节\"></a>主从复制的细节</h2><ul>\n<li>主机可以写，从机不能，只能读</li>\n<li>主机中的所有数据和信息，都自动被从机保存。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6380&gt; keys *</span><br><span class=\"line\">1) <span class=\"string\">\"k1\"</span></span><br><span class=\"line\">127.0.0.1:6380&gt; get k1</span><br><span class=\"line\"><span class=\"string\">\"v1\"</span></span><br><span class=\"line\">127.0.0.1:6380&gt; <span class=\"built_in\">set</span> k2 v2</span><br><span class=\"line\">(error) READONLY You can<span class=\"string\">'t write against a read only replica.</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>主机断开连接，从机依旧连接到主机，重新连接之后，正常工作。</li>\n</ul>\n<p><strong>复制原理</strong><br>Slave启动成功之后连接到master后会发送一个sync命令</p>\n<p>Master接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集的命令，在后台进程执行完毕之hi偶，master将传送整个数据文件到slave，并完成一次完全同步。</p>\n<p>全量复制：slave服务在接收到数据库文件数据后，将其存盘并加载到内存中</p>\n<p>增量复制：Master继续将新的所有收集到的修改命令依次传递个slave，完成同步</p>\n<p>但是要重新连接master，一次完全同步（全量复制）将被自动执行。</p>\n<h2 id=\"哨兵模式（重点）\"><a href=\"#哨兵模式（重点）\" class=\"headerlink\" title=\"哨兵模式（重点）\"></a>哨兵模式（重点）</h2><h3 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h3><p>主从切换技术的方法是：当主服务器宕机之后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费时费力，同时会造成一段时间内服务不可用。更多时候，需要考虑使用哨兵模式。</p>\n<p>哨兵模式是一种特殊的模式，首先Redis提供哨兵的命令，哨兵是一个独立的进程，作为进程，独立运行。原理是<strong>哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例</strong></p>\n<p>在这里，烧饼的两个作用</p>\n<ul>\n<li>通过发送命令，让Redis服务器返回监控器运行状态信息，包括主从服务器</li>\n<li>当哨兵监测到master宕机，会自动将slave切换成master，然后通过发部订阅模式通知其他的从服务器，修改配置文件，切换主机。</li>\n</ul>\n<p><img src=\"image-20200620224443469.png\" alt=\"alt\"></p>\n<p>然而一个哨兵进程对Redis服务器进行监控，可能会 出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控</p>\n<p><img src=\"image-20200620225048149.png\" alt=\"alt\"></p>\n<p>假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover过程，仅仅是哨兵1主观的认为主服务器不可用，这个想象称为<strong>主观下线</strong>。当后面的哨兵也检测到主服务器不可用，并且数量达到一定的值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行failover（故障转移）操作。切换成功周，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为<strong>客观下线</strong>。</p>\n<h3 id=\"配置哨兵配置文件sentinel-conf\"><a href=\"#配置哨兵配置文件sentinel-conf\" class=\"headerlink\" title=\"配置哨兵配置文件sentinel.conf\"></a>配置哨兵配置文件sentinel.conf</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#sentinel monitor 被监控的名称 host port 1</span></span><br><span class=\"line\">sentinel monitor myredis 127.0.0.1 6379 1</span><br></pre></td></tr></table></figure>\n\n<p>后面的数字1，代表主机挂了，slave投票看让谁替换成为主机，票数最多的，成为主机</p>\n<h3 id=\"启动哨兵\"><a href=\"#启动哨兵\" class=\"headerlink\" title=\"启动哨兵\"></a>启动哨兵</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis-sentinel myconfig/setinel.conf</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"image-20200620220120366.png\" alt=\"alt\"></p>\n<h3 id=\"主机宕机\"><a href=\"#主机宕机\" class=\"headerlink\" title=\"主机宕机\"></a>主机宕机</h3><p><img src=\"image-20200620220639671.png\" alt=\"alt\"></p>\n<p><img src=\"image-20200620220651142.png\" alt=\"alt\"></p>\n<p>发现主机已经变为6380</p>\n<p><img src=\"image-20200620220740201.png\" alt=\"alt\"></p>\n<p>如果主机回来了，只能成为slave</p>\n<p><img src=\"image-20200620220854684.png\" alt=\"alt\"></p>\n","categories":[],"tags":[{"name":"Redis","path":"api/tags/Redis.json"}]}